@page "{id}"
@model JurisdictionModel
@{
    ViewData["Title"] = "Official Fee Calculation";
}

<div class="row">
    <div class="col-4">
        <h1>User Input</h1>
        <form asp-page-handler="Result" method="post">
            <input type="hidden" asp-for="@Model.Id" />
            <div class="col-md-9">
                @for (int i = 0; i < Model.Inputs.Count; i++)
                {
                    <input type="hidden" asp-for="@Model.Inputs[i].Name" />
                    <input type="hidden" asp-for="@Model.Inputs[i].Type" />
                    switch (Model.Inputs[i].Var)
                    {
                        case DslInputDate:
                            var v0 = (DslInputDate)Model.Inputs[i].Var;                            
                            <div class="mb-3 col-md-6">
                                <label class="form-label" for="@v0.Name">@v0.Text</label>
                                <input class="form-control" type="date" asp-for="@Model.Inputs[i].DateValue" value="@v0.DefaultValue.ToString("yyyy-MM-dd")" min="@v0.MinValue.ToString("yyyy-MM-dd")" max="@v0.MaxValue.ToString("yyyy-MM-dd")">
                            </div>
                            break;
                        case DslInputList:
                            var v1 = (DslInputList)Model.Inputs[i].Var;
                            <label class="form-label" for="@v1.Name">@v1.Text</label>
                            <select class="form-select form-select-lg mb-3" asp-for="@Model.Inputs[i].StrValue">
                                @foreach (var item in v1.Items)
                                {
                                    if (v1.DefaultSymbol.Equals(item.Symbol))
                                    {
                                        <option selected value="@item.Symbol">@item.Value</option>
                                    }
                                    else
                                    {
                                        <option value="@item.Symbol">@item.Value</option>
                                    }
                                }
                            </select>
                            break;
                        case DslInputListMultiple:
                            var v2 = (DslInputListMultiple)Model.Inputs[i].Var;
                            <label class="form-label" for="@v2.Name">@v2.Text</label>
                            <select class="form-select form-select-lg mb-3" asp-for="@Model.Inputs[i].ListValue" multiple>
                                @foreach (var item in v2.Items)
                                {
                                    if (v2.DefaultSymbols.Contains(item.Symbol))
                                    {
                                        <option selected value="@item.Symbol">@item.Value</option>
                                    }
                                    else
                                    {
                                        <option value="@item.Symbol">@item.Value</option>
                                    }
                                }
                            </select>
                            break;
                        case DslInputNumber:
                            var v3 = (DslInputNumber)Model.Inputs[i].Var;
                            <div class="mb-3 col-md-6">
                                <label class="form-label" for="@v3.Name">@v3.Text</label>
                                <input class="form-control" type="number" asp-for="@Model.Inputs[i].DoubleValue" value="@v3.DefaultValue" min="@v3.MinValue" max="@v3.MaxValue">
                            </div>
                            break;
                        case DslInputBoolean:
                            var v4 = (DslInputBoolean)Model.Inputs[i].Var;
                            <div class="mb-3 form-check">
                                <label class="form-check-label" for="@v4.Name">@v4.Text</label>
                                @if (v4.DefaultValue)
                                {
                                    <input class="form-check-input" type="checkbox" asp-for="@Model.Inputs[i].BoolValue" value="true" checked>
                                    <input type="hidden" name="@v4.Name" value="false">
                                }
                                else
                                {
                                    <input class="form-check-input" type="checkbox" asp-for="@Model.Inputs[i].BoolValue" value="true">
                                    <input type="hidden" name="@v4.Name" value="false">
                                }
                            </div>
                            break;
                    }
                }
                @if (Model.CalculationPending)
                {
                    <button type="submit" class="btn btn-primary">Compute Result</button>
                }
            </div>
            <div class="col-md-12">
                @if (!Model.CalculationPending)
                {
                    <a asp-area="Run" asp-page="Index">Redo calculation</a>
                    <br />
                    <a asp-area="Jurisdiction" asp-page="Index">Back to jurisdiction list</a>
                }
            </div>
        </form>
    </div>

    <div class="col-8">
        <h1>Calculation Results</h1>
        @if (Model.CalculationPending)
        {
            <div class="col-md-6">
                <p class="text-muted">Pending...</p>
            </div>
        }
        else
        {
            <div class="row">
                <div class="col-md-4">
                    <h4>Total: @((Model.TotalMandatoryAmount + Model.TotalOptionalAmount).ToString("0.00"))</h4>
                </div>
                <div class="col-md-8">
                    <h6>Mandatory Fees: @Model.TotalMandatoryAmount.ToString("0.00") | Optional Fees: @Model.TotalOptionalAmount.ToString("0.00")</h6>
                </div>
            </div>

            @if (Model.CollectedValues != null)
            {
                var i = 1;
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th rowspan="2">Collected Values</th>
                            <th scope="col"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var cv in Model.CollectedValues)
                        {
                            <tr>
                                <td>@i</td>
                                <td>@cv.ToString()</td>
                            </tr>
                            i++;
                        }
                    </tbody>
                </table>
            }

            @if (Model.CalculationSteps != null)
            {
                var i = 1;
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th rowspan="2">Calculation Steps</th>
                            <th scope="col"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var e in Model.CalculationSteps)
                        {
                            <tr>
                                <td>@i</td>
                                <td>@e</td>
                            </tr>
                            i++;
                        }
                    </tbody>
                </table>
            }
            @if (Model.Returns != null)
            {
                var i = 1;
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th rowspan="2">Returns</th>
                            <th scope="col"></th>
                            <th scope="col"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var e in Model.Returns)
                        {
                            <tr>
                                <td>@i</td>
                                <td>@e.Item1</td>
                                <td>@e.Item2</td>
                            </tr>
                            i++;
                        }
                    </tbody>
                </table>
            }
        }
    </div>
</div>